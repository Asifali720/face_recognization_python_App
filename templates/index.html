{% extends 'base.html' %}

{% block content %}

<style>
    .card {
    background-color: var(--card-dark);
    color: var(--text-light);
    border-radius: 12px;
    border: 1px solid var(--primary-color);
    box-shadow: var(--shadow-purple);
    transition: transform 0.3s ease-in-out;
}

.card:hover {
    transform: translateY(-5px); /* Hover effect */
}

.card-title {
    color: var(--primary-color);
    font-weight: 700 !important;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 8px;
    margin-bottom: 15px;
}

/* Customizing Bootstrap Buttons */
.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    transition: all 0.3s;
}

.btn-primary:hover {
    background-color: #7d26da;
    border-color: #7d26da;
    box-shadow: 0 0 10px var(--primary-color);
}

.btn-success {
    background-color: #00b894; /* Brighter Green for "Start" */
    border-color: #00b894;
}

.btn-success:hover {
    background-color: #00e6a8;
    border-color: #00e6a8;
}

/* Stream and Image Area Styling */
.ratio-16x9 {
    background-color: #000000; /* Pure Black for video feed */
    border: 2px solid var(--primary-color);
    border-radius: 8px !important;
}

/* Last Detection Box */
.last-detection-box {
    background-color: #2c2c2c;
    border: 1px solid #444;
    border-left: 5px solid var(--primary-color); /* Highlight with purple border */
}

/* List Group for Users */
.list-group-item {
    background-color: #252525;
    color: var(--text-light);
    border: 1px solid #333;
    margin-bottom: 5px;
    border-radius: 8px !important;
    transition: background-color 0.2s;
}

.list-group-item:hover {
    background-color: #383838;
}

.form-control {
    background-color: #2c2c2c;
    color: var(--text-light);
    border: 1px solid #444;
}
.form-control:focus {
    background-color: #2c2c2c;
    color: var(--text-light);
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(106, 13, 173, 0.5);
}
</style>
<!-- HERO SECTION -->
<section class="py-5 px-3"
    style="
        background: radial-gradient(circle at right, #481197, #120022 60%);
        color: white;
    ">
    <div class="container">
        <div class="row align-items-center">

            <!-- Left Text -->
            <div class="col-lg-6 mb-4">
                <h1 class="fw-bold display-5" style="color: whitesmoke; text-align: left;">
                    Unlock the Future<br>
                    with <span style="color:#b56bff;">AI-Powered</span><br>
                    Face Recognition
                </h1>
                <p class="mt-3 text-light opacity-75">
                    Seamless, secure, and lightning-fast face detection for authentication,
                    attendance, and identity verification.
                </p>

                <div class="mt-4">
                    <a href="{{ url_for('register') }}" class="btn px-4 py-2 me-2"
                        style="background:#b300ff; color:white; border-radius:12px;">
                        Get Started
                    </a>
                    <a href="{{ url_for('login') }}" class="btn px-4 py-2"
                        style="background:#ffffff22; backdrop-filter:blur(8px); color:white; border-radius:12px;">
                        Sign In
                    </a>
                </div>
            </div>

            <!-- Right AI Face Image -->
            <div class="col-lg-6 text-center">
                <img src="{{ url_for('static', filename='images/hero-face.jpg') }}"
                     class="img-fluid"
                     style="max-height:360px; border-radius:20px;
                     box-shadow:0 0 25px #8a2be2;">
            </div>

        </div>
    </div>
</section>

<!-- FEATURE CARDS -->
<section class="py-5" style="background:#0e001d;">
    <div class="container">
        <div class="row g-4">

            {% for item in [
                ('Live Camera Stream', 'fas fa-video'),
                ('Recognize from Image', 'fas fa-image'),
                ('Registered Users', 'fas fa-users'),
                ('Attendance Reports', 'fas fa-file-alt')
            ] %}
            <div class="col-md-6 col-lg-3">
                <div class="p-4 rounded-4 text-center shadow-lg"
                     style="
                       backdrop-filter: blur(20px);
                       background: rgba(255,255,255,0.06);
                       border:1px solid rgba(255,255,255,0.1);
                       color:white;
                     ">
                    <i class="{{ item[1] }} mb-3" style="font-size:2rem; color:#bf71ff;"></i>
                    <h5 class="fw-bold" style="white-space: nowrap;">{{ item[0] }}</h5>
                </div>
            </div>
            {% endfor %}

        </div>
    </div>
</section>


<section class="py-5">
    <div class="container">
        <h2 class="text-center fw-bolder mb-5" style="color:var(--primary-color);">
            <i class="bi bi-person-badge-fill me-2"></i> Face Recognition Dashboard
        </h2>

        <div class="row g-4">

            <div class="col-lg-6">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title">Live Camera Stream</h5>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="badge bg-danger" id="streamStatus">OFFLINE</span>
                            </div>
                            <div>
                                <button id="startStreams" class="btn btn-sm btn-success me-2"
                                    onclick="startStreamAction()">Start</button>
                                <button id="stopStreams" class="btn btn-sm btn-secondary"
                                    onclick="stopStreamAction()">Stop</button>
                            </div>
                        </div>
                        
                        <div class="ratio ratio-16x9 rounded">
                            <img id="cam1"
                                 data-src="{{ url_for('video1') }}"
                                 style="width:100%; height:100%; object-fit:cover; filter: brightness(0.9);">
                        </div>

                        <div class="mt-4">
                            <small class="text-muted d-block mb-1">Last Detected Person:</small>
                            <div class="p-3 last-detection-box rounded">
                                <strong id="lastName" class="fs-5">None</strong>
                                <span id="lastReg" class="text-muted d-block mt-1">N/A</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title">Recognize from Image</h5>

                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="input-group mb-4">
                                <input type="file" class="form-control" id="imageFile"
                                    accept="image/*" required onchange="previewImage()">
                                <button class="btn btn-primary" type="button"
                                    onclick="recognizeImage()">Recognize</button>
                            </div>
                        </form>

                        <div id="imagePreviewContainer" style="display:none; text-align:center;" class="mb-4">
                            <h6 class="text-muted">Image Preview:</h6>
                            <img id="imagePreview" class="rounded shadow-lg"
                                 style="max-width:300px; max-height:200px; object-fit:cover; border: 3px solid var(--primary-color);">
                        </div>

                        <div id="uploadResult" class="mt-2 p-3 rounded" style="background-color: #2c2c2c;">
                             <small class="text-muted">Recognition Status will appear here.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="card-title">Registered Users <span class="badge bg-secondary">{{ users|length }}</span></h5>
                        
                        <div class="row g-3">
                            {% for u in users %}
                            <div class="col-6 col-md-4 col-lg-3">
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <div>
                                        <strong class="text-uppercase">{{ u.name }}</strong><br>
                                        <small class="text-muted">{{ u.regid }}</small>
                                    </div>

                                    {% set thumb = u.regid ~ '.jpg' %}
                                    {% if uploads and thumb in uploads %}
                                    <img src="{{ url_for('get_image', filename=thumb) }}"
                                         style="width:60px; height:60px; object-fit:cover; border: 2px solid var(--primary-color);"
                                         class="rounded-circle ms-3">
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="py-5 text-center text-white"
    style="background: linear-gradient(135deg, #7b2ff7, #4b00e0);">
    <h2 class="fw-bold">Manage Your AI Face Attendance System</h2>
    <p class="opacity-75">Add new users or access your dashboard.</p>

    <a href="{{ url_for('register') }}" class="btn btn-light px-4 py-2 me-2 rounded-pill">
        Add User
    </a>

    <a href="{{ url_for('login') }}" class="btn btn-outline-light px-4 py-2 rounded-pill">
        Sign In
    </a>
</section>


<footer class="py-4 text-center text-white"
    style="
        background: linear-gradient(135deg, #120033, #2d006b, #4800b8);
        border-top: 1px solid rgba(255,255,255,0.1);
    ">
    <p class="mb-0">© 2025 Face Attendance AI — All Rights Reserved</p>
</footer>



    <script>
        // Simple reload helper
        function reloadPage() {
            location.reload();
        }

        // Preview image when user selects a file
        function previewImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            const previewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.style.display = 'none';
            }
        }

        // Function to recognize face from uploaded image
        async function recognizeImage() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];
            const resultDiv = document.getElementById('uploadResult');

            if (!file) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select an image.</div>';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                resultDiv.innerHTML = '<div class="alert alert-info">Processing...</div>';
                const response = await fetch('{{ url_for("video2") }}', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let html = '<div class="alert alert-success"><strong>✓ Face Recognized!</strong><br>';
                    html += '<strong>Name:</strong> ' + result.data.name + '<br>';
                    html += '<strong>Roll No:</strong> ' + result.data.roll_no + '<br>';
                    html += '<strong>Reg ID:</strong> ' + result.data.reg_id + '<br>';
                    html += '<strong>Branch:</strong> ' + result.data.branch + '</div>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = '<div class="alert alert-danger"><strong>✗ ' + result.message + '</strong></div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
                console.error('Error:', error);
            }
        }
    </script>

    <script>
        // Attach/detach stream image sources on user action to avoid opening cameras on page load
        // Ensure the code runs after DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            console.log('stream controls script loaded');
            const startBtn = document.getElementById('startStreams');
            const stopBtn = document.getElementById('stopStreams');
            const cam1 = document.getElementById('cam1');
            const lastNameEl = document.getElementById('lastName');
            const lastRegEl = document.getElementById('lastReg');

            if (!startBtn || !stopBtn || !cam1) {
                console.warn('Stream controls or camera elements not found', {startBtn, stopBtn, cam1});
                return;
            }

            // Poll the server for last detection and update the UI. Optionally speak changes.
            let lastSeen = null;
            async function pollDetection() {
                try {
                    const res = await fetch("{{ url_for('last_detection_route') }}");
                    if (!res.ok) return;
                    const data = await res.json();
                    if (!data) return;
                    const key = (data.name || '') + '|' + (data.reg_id || '');
                    if (key !== lastSeen) {
                        lastSeen = key;
                        if (lastNameEl) lastNameEl.textContent = data.name || 'Unknown';
                        if (lastRegEl) lastRegEl.textContent = data.reg_id ? ('(' + data.reg_id + ')') : '';
                        // speak the detection briefly
                        if (data.name && data.name !== 'Unknown' && 'speechSynthesis' in window) {
                            const utter = new SpeechSynthesisUtterance(`${data.name}, ID ${data.reg_id}`);
                            window.speechSynthesis.cancel();
                            window.speechSynthesis.speak(utter);
                        }
                    }
                } catch (e) {
                    // ignore polling errors silently
                    console.debug('pollDetection error', e);
                }
            }
            setInterval(pollDetection, 1000);

            function start() {
                console.log('Start streams');
                if (cam1 && cam1.dataset && cam1.dataset.src) {
                    cam1.onerror = () => { if (lastNameEl) lastNameEl.textContent = 'Camera failed'; if (lastRegEl) lastRegEl.textContent = ''; };
                    cam1.onload = () => { /* loaded */ };
                    cam1.src = cam1.dataset.src;
                }
                startBtn.disabled = true;
                stopBtn.disabled = false;
            }

            function stop() {
                console.log('Stop streams');
                if (cam1) cam1.src = '';
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }

            // expose functions as global fallbacks for inline onclick
            window.startStreamAction = start;
            window.stopStreamAction = stop;

            // attach event listeners as well
            try {
                startBtn.addEventListener('click', start);
                stopBtn.addEventListener('click', stop);
            } catch (e) {
                console.debug('failed to attach listeners', e);
            }

            // Initial state: streams stopped
            stopBtn.disabled = true;
        });
    </script>

{% endblock %}