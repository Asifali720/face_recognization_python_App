{% extends 'base.html' %}

{% block content %}

<!-- Include Font Awesome -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> -->

<div class="row justify-content-center" style="padding-top: 40px; padding-bottom:40px; overflow-x: hidden;">
    <div class="col-md-8" style="max-width: 650px;">

        <div class="card shadow-lg"
            style="
                background: rgba(20,0,30,0.65);
                backdrop-filter: blur(15px);
                border-radius: 20px;
                border: 1px solid rgba(200,0,255,0.2);
                box-shadow: 0 0 25px rgba(200,0,255,0.3);
                color: white;
            "
        >
            <div class="card-body">

                <h3 class="card-title mb-2 text-center"
                    style="font-weight:700; color:#d56bff; text-shadow:0 0 8px #9b4dff;">
                    Register Account
                </h3>

                <p class="text-center" style="color:#ddd;">Create your secure biometric account</p>

                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, msg in messages %}
                        <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} mt-2" role="alert">{{ msg }}</div>
                    {% endfor %}
                {% endif %}
                {% endwith %}

                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                <form method="POST" action="{{ url_for('register') }}" class="mt-4">

                    <!-- Username -->
                    <div class="mb-3">
                        <label for="username" class="form-label" style="color:#d8baff;">Username</label>
                        <input type="text" name="username" id="username" required
                            class="form-control"
                            style="
                                border-radius: 50px;
                                background: rgba(255,255,255,0.1);
                                color: white;
                                border: 1px solid rgba(200,0,255,0.3);
                            ">
                    </div>

                    <!-- Email -->
                    <div class="mb-3">
                        <label for="email" class="form-label" style="color:#d8baff;">Email</label>
                        <input type="email" name="email" id="email" required
                            class="form-control"
                            style="
                                border-radius: 50px;
                                background: rgba(255,255,255,0.1);
                                color: white;
                                border: 1px solid rgba(200,0,255,0.3);
                            ">
                    </div>

                    <!-- Age -->
                    <div class="mb-3">
                        <label for="age" class="form-label" style="color:#d8baff;">Age</label>

                        <div class="input-group" style="max-width:170px;">
                            <span class="input-group-text"
                                style="
                                    background:#430063;
                                    border:1px solid #b84dff;
                                    color:#fff;
                                ">ðŸŽ‚</span>

                            <input type="number" min="1" placeholder="21"
                                name="age" id="age" required class="form-control"
                                style="
                                    border-radius:50px;
                                    background:rgba(255,255,255,0.1);
                                    color:white;
                                    border:1px solid rgba(200,0,255,0.3);
                                ">
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label for="password" class="form-label" style="color:#d8baff;">Password</label>

                        <div class="input-group">
                            <input type="password" name="password" id="password" required
                                class="form-control"
                                style="
                                    border-radius:50px 0 0 50px;
                                    background:rgba(255,255,255,0.1);
                                    color:white;
                                    border:1px solid rgba(200,0,255,0.3);
                                ">

                            <button type="button" id="togglePassword"
                                class="btn"
                                style="
                                    border-radius:0 50px 50px 0;
                                    background:#430063;
                                    color:#fff;
                                    border:1px solid #b84dff;
                                ">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Camera Section -->
                    <div class="mb-4">
                        <p style="color:#d8baff;">Capture Live Face (Required)</p>

                        <div style="display:flex; gap:20px;">
                            <div>

                                <div id="videoContainer"
                                    style="
                                        position:relative;
                                        width:320px;
                                        height:240px;
                                        border-radius: 15px;
                                        overflow:hidden;
                                        border:1px solid #b84dff;
                                        box-shadow:0 0 10px rgba(200,0,255,0.4);
                                    ">

                                    <video id="video" width="320" height="240"
                                        playsinline
                                        style="display:none; border-radius:15px;"></video>

                                    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

                                    <div id="captureOverlay"
                                         style="
                                            display:none;
                                            position:absolute;
                                            inset:0;
                                            background:rgba(0,0,0,0.6);
                                            backdrop-filter: blur(4px);
                                            color:#fff;
                                            font-size:1.2rem;
                                            font-weight:600;
                                            align-items:center;
                                            justify-content:center;
                                            display:flex;
                                         ">
                                         Capturing...
                                    </div>
                                </div>

                                <div class="mt-2">
                                    <label class="form-label" style="color:#d8baff;">Preview</label>
                                    <div style="
                                            width:320px;
                                            height:240px;
                                            background:rgba(255,255,255,0.05);
                                            display:flex;
                                            align-items:center;
                                            justify-content:center;
                                            border-radius:15px;
                                            border:1px solid rgba(200,0,255,0.2);
                                            overflow:hidden;
                                        ">
                                        <img id="preview" style="max-width:100%; display:none; border-radius:15px;">
                                    </div>

                                    <button type="button" id="captureBtn"
                                        class="btn mt-2"

                                        style="
                                            background:#b300ff;
                                            color:white;
                                            border:none;
                                            padding:8px 18px;
                                            border-radius:50px;
                                            font-weight:600;
                                            box-shadow:0 0 10px rgba(200,0,255,0.4);
                                        ">
                                        Capture Face
                                    </button>

                                    <span id="captureStatus" style="color:#ccc; margin-left:10px;"></span>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="captured_image" id="captured_image">
                    </div>

                    <!-- Submit -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <a href="{{ url_for('login') }}" style="color:#e26cff;">Already registered? Login</a>

                        <button class="btn"
                            style="
                                background:#b300ff;
                                color:white;
                                font-weight:600;
                                border:none;
                                padding:8px 25px;
                                border-radius:50px;
                                box-shadow:0 0 12px rgba(200,0,255,0.5);
                            ">
                            Register
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<!-- JS Password Toggle -->
<script>
    document.getElementById('togglePassword').addEventListener('click', function () {
        const pwd = document.getElementById('password');
        const icon = this.querySelector('i');
        const isHidden = pwd.type === "password";

        pwd.type = isHidden ? "text" : "password";
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });
</script>

<!-- Camera Capture Script -->
<script>
    let mediaStream = null;
    let isCameraActive = false;

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const captureBtn = document.getElementById('captureBtn');
    const captureStatus = document.getElementById('captureStatus');
    const capturedImageInput = document.getElementById('captured_image');
    const videoContainer = document.getElementById('videoContainer');
    const captureOverlay = document.getElementById('captureOverlay');

    // Start camera on page load
    async function startCamera() {
        try {
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: 'user',
                    width: { ideal: 320 },
                    height: { ideal: 240 }
                }
            });
            
            video.srcObject = mediaStream;
            video.style.display = 'block';
            isCameraActive = true;
            captureStatus.textContent = 'âœ“ Camera ready';
            captureStatus.style.color = '#00ff00';
            
            video.onloadedmetadata = function() {
                video.play();
            };
        } catch (err) {
            console.error('Camera access denied:', err);
            captureStatus.textContent = 'âœ— Camera access denied';
            captureStatus.style.color = '#ff0000';
        }
    }

    // Capture face image
    captureBtn.addEventListener('click', function() {
        if (!isCameraActive) {
            captureStatus.textContent = 'âœ— Camera not ready';
            captureStatus.style.color = '#ff0000';
            return;
        }

        // Show capturing overlay
        captureOverlay.style.display = 'flex';

        // Draw video frame to canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Convert canvas to image
        setTimeout(() => {
            const imageData = canvas.toDataURL('image/jpeg');
            preview.src = imageData;
            preview.style.display = 'block';
            capturedImageInput.value = imageData;
            
            captureOverlay.style.display = 'none';
            captureStatus.textContent = 'âœ“ Face captured successfully';
            captureStatus.style.color = '#00ff00';
        }, 500);
    });

    // Start camera when page loads
    window.addEventListener('load', startCamera);

    // Stop camera on page unload
    window.addEventListener('beforeunload', function() {
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
        }
    });
</script>

{% endblock %}
